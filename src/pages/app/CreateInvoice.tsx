import { motion } from "framer-motion"
import { useState, useEffect, useRef } from "react"
import { useNavigate } from "react-router-dom"
import { 
  ArrowLeft, 
  Calendar, 
  DollarSign, 
  User, 
  Mail, 
  FileText,
  Plus,
  Trash2,
  Check,
  Loader2,
  CheckCircle2,
  ExternalLink,
  Copy
} from "lucide-react"
import { Link } from "react-router-dom"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Textarea } from "@/components/ui/textarea"
import {
  Dialog,
  DialogContent,
} from "@/components/ui/dialog"
import { toast } from "sonner"
import { useCreateInvoice } from "@/hooks/useInvoice"
import { usePrivyAccount } from "@/hooks/usePrivyAccount"
import { isAddress, decodeEventLog } from "viem"
import { InvoiceRegistryABI } from "@/lib/abis"

interface LineItem {
  id: string
  description: string
  quantity: number
  rate: number
}

export default function CreateInvoice() {
  const navigate = useNavigate()
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [lineItems, setLineItems] = useState<LineItem[]>([
    { id: "1", description: "", quantity: 1, rate: 0 }
  ])
  
  const [formData, setFormData] = useState({
    buyerAddress: "", // Ethereum address
    buyerName: "",
    buyerEmail: "",
    dueDate: "",
    memo: ""
  })
  
  const { address } = usePrivyAccount()
  const { createInvoice, isPending, isConfirming, isSuccess, error, hash, receipt } = useCreateInvoice()
  const successToastShown = useRef<string | null>(null)
  const submittedToastShown = useRef<string | null>(null)
  const [successModalOpen, setSuccessModalOpen] = useState(false)
  const [successHash, setSuccessHash] = useState<string | null>(null)
  
  // Show toast when transaction is submitted
  useEffect(() => {
    if (hash && !submittedToastShown.current) {
      submittedToastShown.current = hash
      toast.info("Transaction submitted", {
        description: "Please confirm the transaction in your wallet, then wait for on-chain confirmation...",
        duration: 5000,
      })
    }
  }, [hash])

  // Show toast when transaction is confirming
  useEffect(() => {
    if (hash && isConfirming && !isSuccess && submittedToastShown.current === hash) {
      toast.info("Transaction confirming", {
        description: "Waiting for on-chain confirmation...",
        duration: 3000,
      })
    }
  }, [hash, isConfirming, isSuccess])
  
  // Debug logging
  useEffect(() => {
    if (hash) {
      console.log('üîç CreateInvoice component state:', {
        hash,
        isPending,
        isConfirming,
        isSuccess,
        receiptStatus: receipt?.status,
        error: error?.message,
      });
    }
  }, [hash, isPending, isConfirming, isSuccess, receipt, error])

  const totalAmount = lineItems.reduce((sum, item) => sum + item.quantity * item.rate, 0)

  const addLineItem = () => {
    setLineItems([
      ...lineItems,
      { id: Date.now().toString(), description: "", quantity: 1, rate: 0 }
    ])
  }

  const removeLineItem = (id: string) => {
    if (lineItems.length > 1) {
      setLineItems(lineItems.filter((item) => item.id !== id))
    }
  }

  const updateLineItem = (id: string, field: keyof LineItem, value: string | number) => {
    setLineItems(
      lineItems.map((item) =>
        item.id === id ? { ...item, [field]: value } : item
      )
    )
  }

  // Show success toast and modal when transaction is confirmed and store buyer metadata
  useEffect(() => {
    if (hash && isSuccess && receipt && successToastShown.current !== hash) {
      successToastShown.current = hash
      setIsSubmitting(false)
      setSuccessHash(hash)
      
      // Show success toast
      toast.success("Invoice created successfully!", {
        description: "Your invoice has been created on-chain.",
        duration: 5000,
      })
      
      // Open success modal
      setSuccessModalOpen(true)
      
      // Extract invoice ID from transaction receipt logs
      let invoiceId: bigint | null = null
      try {
        if (receipt.logs) {
          for (const log of receipt.logs) {
            try {
              const decoded = decodeEventLog({
                abi: InvoiceRegistryABI,
                data: log.data,
                topics: log.topics,
              })
              if (decoded.eventName === 'InvoiceCreated') {
                invoiceId = decoded.args.invoiceId as bigint
                break
              }
            } catch (e) {
              // Not an InvoiceCreated event, continue
            }
          }
        }
      } catch (e) {
        console.error('Error decoding invoice ID from receipt:', e)
      }
      
      // Store buyer metadata in localStorage keyed by invoice ID
      if ((formData.buyerName || formData.buyerEmail) && invoiceId) {
        const buyerMetadata = {
          buyerName: formData.buyerName || '',
          buyerEmail: formData.buyerEmail || '',
        }
        localStorage.setItem(`invoice_metadata_${invoiceId.toString()}`, JSON.stringify(buyerMetadata))
      } else if (formData.buyerName || formData.buyerEmail) {
        // Fallback: store with transaction hash if invoice ID not found
        const buyerMetadata = {
          buyerName: formData.buyerName || '',
          buyerEmail: formData.buyerEmail || '',
        }
        localStorage.setItem(`invoice_metadata_hash_${hash}`, JSON.stringify(buyerMetadata))
      }
    }
  }, [hash, isSuccess, receipt, formData.buyerName, formData.buyerEmail])


  // Watch for errors - only show if transaction actually failed (not if it succeeded)
  useEffect(() => {
    if (error && !isSuccess && !receipt) {
      // Don't show error if transaction succeeded (isSuccess or receipt exists)
      // Check if it's an "already known" type error (transaction might have succeeded)
      const isAlreadyKnown = error.message?.includes('already known') || 
                            error.message?.includes('already be submitted') ||
                            error.message?.includes('nonce too low')
      
      // Check if it's a temporary RPC error that suggests retry
      const isTemporaryRpcError = error.message?.includes('Network temporarily unavailable') ||
                                  error.message?.includes('temporary') ||
                                  error.message?.includes('Please retry')
      
      if (isAlreadyKnown && hash) {
        // If we have a hash, transaction was likely submitted successfully
        // Don't show error, just log it
        console.log('Transaction may have been submitted despite error:', error.message)
        return
      } else if (isAlreadyKnown && !hash) {
        toast.warning("Transaction may already be submitted", {
          description: "Please check your wallet transactions. The invoice might have been created successfully.",
          duration: 8000,
        })
      } else if (isInsufficientFunds) {
        // Show user-friendly message for insufficient funds
        toast.error("üí∏ Insufficient Funds", {
          description: (
            <div className="space-y-1">
              <p>{error.message || "You don't have enough MNT to pay for gas fees."}</p>
              <p className="text-sm text-muted-foreground">Please add more MNT (Mantle native token) to your wallet.</p>
            </div>
          ),
          duration: 12000, // Show longer for important message
        })
      } else if (isTemporaryRpcError) {
        // Show user-friendly message for temporary RPC errors
        toast.error("‚ö†Ô∏è Network Error - Please Retry", {
          description: (
            <div className="space-y-1">
              <p>{error.message || "The network is temporarily unavailable. Please wait a moment and try again."}</p>
              <p className="text-sm text-muted-foreground">This is usually a temporary issue with the RPC endpoint.</p>
            </div>
          ),
          duration: 10000, // Show longer for retry instructions
        })
      } else {
        // Only show error if transaction definitely failed (no hash, no success)
        toast.error("‚ùå Failed to create invoice", {
          description: (
            <div className="space-y-1">
              <p>{error.message || "Please check your wallet and try again"}</p>
              {hash && (
                <a
                  href={`https://explorer.testnet.mantle.xyz/tx/${hash}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-destructive underline hover:text-destructive/80 text-sm"
                >
                  Check transaction: {hash.substring(0, 10)}...
                </a>
              )}
            </div>
          ),
          duration: 10000,
        })
      }
      setIsSubmitting(false)
    }
  }, [error, hash, isSuccess, receipt])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    // Validate buyer address
    if (!formData.buyerAddress || !isAddress(formData.buyerAddress)) {
      toast.error("Invalid buyer address", {
        description: "Please enter a valid Ethereum address (0x...)",
      })
      return
    }

    // Validate due date
    if (!formData.dueDate) {
      toast.error("Due date required", {
        description: "Please select a due date",
      })
      return
    }

    const dueDateTimestamp = Math.floor(new Date(formData.dueDate).getTime() / 1000)
    
    if (dueDateTimestamp <= Math.floor(Date.now() / 1000)) {
      toast.error("Invalid due date", {
        description: "Due date must be in the future",
      })
      return
    }

    if (totalAmount <= 0) {
      toast.error("Invalid amount", {
        description: "Total amount must be greater than 0",
      })
      return
    }

    setIsSubmitting(true)

    try {
      // Create metadata hash from line items (optional - can be empty for now)
      const metadata = {
        lineItems: lineItems,
        memo: formData.memo,
        buyerName: formData.buyerName,
        buyerEmail: formData.buyerEmail,
      }
      const metadataHash = "0x0000000000000000000000000000000000000000000000000000000000000000" // TODO: Hash metadata if needed

      // Call on-chain createInvoice
      // Toast messages for transaction status are handled by useEffect hooks above
      const result = await createInvoice(
        formData.buyerAddress,
        totalAmount.toString(),
        dueDateTimestamp,
        metadataHash
      )
      
      // Store buyer metadata in localStorage (keyed by invoice ID after creation)
      // We'll store it once we get the invoice ID from the transaction receipt
      
      // If we got a result (even without hash), transaction was submitted
      // Success detection will work via useEffect hooks
      if (result) {
        console.log('Transaction submitted, waiting for confirmation...', result)
      }
    } catch (err: any) {
      console.error("Error creating invoice:", err)
      
      // Only show error if it's not an "already known" type error
      // (those mean transaction was actually submitted)
      const errorMessage = err?.message || String(err || '');
      const errorMsgLower = errorMessage.toLowerCase();
      const isAlreadyKnown = errorMessage.includes('already known') || 
                            errorMessage.includes('Transaction appears to have been submitted');
      const isTemporaryRpcError = errorMessage.includes('Network temporarily unavailable') ||
                                  errorMessage.includes('temporary') ||
                                  errorMessage.includes('Please retry') ||
                                  errorMessage.includes('Status: 500') ||
                                  errorMessage.includes('Temporary internal error');
      const isInsufficientFunds = errorMsgLower.includes('insufficient funds') ||
                                  errorMsgLower.includes('insufficient balance') ||
                                  errorMessage.includes('overshot') ||
                                  errorMsgLower.includes('insufficient funds for gas');
      
      if (!isAlreadyKnown) {
        if (isInsufficientFunds) {
          toast.error("üí∏ Insufficient Funds", {
            description: errorMessage || "You don't have enough MNT to pay for gas fees. Please add more MNT to your wallet.",
            duration: 12000,
          })
        } else if (isTemporaryRpcError) {
          toast.error("‚ö†Ô∏è Network Error - Please Retry", {
            description: errorMessage || "The network is temporarily unavailable. Please wait a moment and try again.",
            duration: 10000,
          })
        } else {
          toast.error("Failed to create invoice", {
            description: errorMessage || "Please try again",
          })
        }
      }
      setIsSubmitting(false)
    }
  }

  return (
    <div>
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="mx-auto max-w-3xl space-y-6"
    >
      {/* Header */}
      <div className="flex items-center gap-4">
        <Button variant="ghost" size="icon" asChild>
          <Link to="/app/invoices">
            <ArrowLeft className="h-5 w-5" />
          </Link>
        </Button>
        <div>
          <h1 className="text-3xl font-bold tracking-tight">Create Invoice</h1>
          <p className="text-muted-foreground">
            Create a new invoice payment link
          </p>
        </div>
      </div>

      <form onSubmit={handleSubmit} className="space-y-5">
        {/* Buyer details */}
        <div className="rounded-xl border border-border bg-card p-6 shadow-md">
          <h2 className="mb-4 text-lg font-semibold">Buyer Details</h2>
          <div className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="buyerAddress">
                <User className="mr-2 inline h-4 w-4" />
                Buyer Wallet Address <span className="text-destructive">*</span>
              </Label>
              <Input
                id="buyerAddress"
                placeholder="0x..."
                value={formData.buyerAddress}
                onChange={(e) => setFormData({ ...formData, buyerAddress: e.target.value })}
                required
                className="font-mono"
              />
              <p className="text-xs text-muted-foreground">
                The Ethereum address that will receive and pay the invoice
              </p>
            </div>
            <div className="grid gap-4 md:grid-cols-2">
              <div className="space-y-2">
                <Label htmlFor="buyerName">
                  Buyer Name (optional)
                </Label>
                <Input
                  id="buyerName"
                  placeholder="Company or person name"
                  value={formData.buyerName}
                  onChange={(e) => setFormData({ ...formData, buyerName: e.target.value })}
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="buyerEmail">
                  <Mail className="mr-2 inline h-4 w-4" />
                  Email (optional)
                </Label>
                <Input
                  id="buyerEmail"
                  type="email"
                  placeholder="billing@company.com"
                  value={formData.buyerEmail}
                  onChange={(e) => setFormData({ ...formData, buyerEmail: e.target.value })}
                />
              </div>
            </div>
          </div>
        </div>

        {/* Line items */}
        <div className="rounded-xl border border-border bg-card p-4 md:p-6 shadow-md">
          <h2 className="mb-4 text-lg font-semibold">Line Items</h2>
          <div className="space-y-4 md:space-y-4">
            {lineItems.map((item, index) => (
              <motion.div
                key={item.id}
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: 20 }}
                className="relative rounded-lg border border-border/50 bg-secondary/30 p-4 md:border-0 md:bg-transparent md:p-0"
              >
                {/* Grid layout */}
                <div className="grid gap-4 md:grid-cols-[1fr_100px_120px_40px] items-end">
                  <div className="space-y-2">
                    <Label htmlFor={`desc-${item.id}`} className="text-sm">
                      <FileText className="mr-2 inline h-4 w-4" />
                      Description
                    </Label>
                    <Input
                      id={`desc-${item.id}`}
                      placeholder="Service or product"
                      value={item.description}
                      onChange={(e) => updateLineItem(item.id, "description", e.target.value)}
                      className="w-full"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor={`qty-${item.id}`} className="text-sm">
                      Qty
                    </Label>
                    <Input
                      id={`qty-${item.id}`}
                      type="number"
                      min="1"
                      value={item.quantity}
                      onChange={(e) => updateLineItem(item.id, "quantity", parseInt(e.target.value) || 1)}
                      className="w-full"
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor={`rate-${item.id}`} className="text-sm">
                      <DollarSign className="mr-2 inline h-4 w-4" />
                      $ Rate
                    </Label>
                    <div className="flex gap-2 items-center">
                      <Input
                        id={`rate-${item.id}`}
                        type="number"
                        min="0"
                        step="0.01"
                        placeholder="0.00"
                        value={item.rate || ""}
                        onChange={(e) => updateLineItem(item.id, "rate", parseFloat(e.target.value) || 0)}
                        className="flex-1"
                        required
                      />
                      {/* Delete button - mobile: same line as rate, desktop: grid item */}
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        onClick={() => removeLineItem(item.id)}
                        disabled={lineItems.length === 1}
                        className="flex-shrink-0 md:hidden text-muted-foreground hover:text-destructive"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                  {/* Delete button - desktop: grid item */}
                  <Button
                    type="button"
                    variant="ghost"
                    size="icon"
                    onClick={() => removeLineItem(item.id)}
                    disabled={lineItems.length === 1}
                    className="hidden md:flex text-muted-foreground hover:text-destructive"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                </div>
              </motion.div>
            ))}
          </div>
          
          <Button
            type="button"
            variant="outline"
            size="sm"
            className="mt-4 w-full md:w-auto"
            onClick={addLineItem}
          >
            <Plus className="mr-2 h-4 w-4" />
            Add Line Item
          </Button>

          {/* Total */}
          <div className="mt-6 flex justify-end border-t border-border pt-4">
            <div className="text-right w-full md:w-auto">
              <p className="text-sm text-muted-foreground">Total Amount</p>
              <p className="text-2xl md:text-3xl font-bold number-display">
                ${totalAmount.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                <span className="ml-2 text-base md:text-lg font-normal text-muted-foreground">USDC</span>
              </p>
            </div>
          </div>
        </div>

        {/* Payment details */}
        <div className="rounded-xl border border-border bg-card p-4 md:p-6 shadow-md">
          <h2 className="mb-3 text-lg font-semibold">Payment Details</h2>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="space-y-2">
              <Label htmlFor="dueDate">
                <Calendar className="mr-2 inline h-4 w-4" />
                Due Date
              </Label>
              <Input
                id="dueDate"
                type="date"
                value={formData.dueDate}
                onChange={(e) => setFormData({ ...formData, dueDate: e.target.value })}
                required
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="currency">Currency</Label>
              <Input
                id="currency"
                value="USDC (on Mantle)"
                disabled
                className="bg-secondary/50"
              />
            </div>
          </div>
          <div className="mt-3 space-y-2">
            <Label htmlFor="memo">Memo (optional)</Label>
            <Textarea
              id="memo"
              placeholder="Additional notes for the buyer..."
              value={formData.memo}
              onChange={(e) => setFormData({ ...formData, memo: e.target.value })}
              rows={2}
              className="resize-none"
            />
          </div>
        </div>

        {/* Actions */}
        <div className="pt-2 border-t border-border">
          <div className="flex flex-row justify-end gap-3">
            <Button variant="outline" type="button" asChild size="sm" className="flex-shrink-0">
              <Link to="/app/invoices">Cancel</Link>
            </Button>
            <Button 
              type="submit" 
              variant="hero"
              size="sm"
              disabled={isPending || isConfirming || isSubmitting || totalAmount === 0 || !address}
              className="flex-shrink-0"
            >
              {isPending || isConfirming ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  {isPending ? "Waiting..." : "Confirming..."}
                </>
              ) : (
                <>
                  <Check className="mr-2 h-4 w-4" />
                  Create Invoice On-Chain
                </>
              )}
            </Button>
          </div>
          {!address && (
            <p className="text-xs text-muted-foreground text-right mt-2">
              Please connect your wallet to create an invoice
            </p>
          )}
        </div>
      </form>
    </motion.div>

    {/* Success Modal - Centered with big green checkmark */}
    <Dialog open={successModalOpen} onOpenChange={setSuccessModalOpen}>
      <DialogContent className="sm:max-w-md text-center">
        <div className="flex flex-col items-center space-y-6 py-6">
          {/* Big Green Checkmark */}
          <div className="flex items-center justify-center w-20 h-20 rounded-full bg-green-100 dark:bg-green-900/20">
            <CheckCircle2 className="h-16 w-16 text-green-600 dark:text-green-500" />
          </div>

          {/* Success Message */}
          <div className="space-y-2">
            <h3 className="text-2xl font-bold">Invoice Created Successfully!</h3>
            <p className="text-muted-foreground">
              Your invoice transaction has been successfully processed.
            </p>
          </div>

          {/* Transaction Hash */}
          {successHash && (
            <div className="w-full space-y-3 pt-4 border-t">
              <div className="space-y-2">
                <span className="text-xs font-semibold uppercase tracking-wide text-muted-foreground">
                  Transaction Hash
                </span>
                <div className="flex items-center gap-2 bg-muted rounded-md p-3 border border-border">
                  <span className="text-sm font-mono break-all flex-1 text-left">{successHash}</span>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="flex-shrink-0"
                    onClick={() => {
                      navigator.clipboard.writeText(successHash)
                      toast.success("Transaction hash copied!")
                    }}
                  >
                    <Copy className="h-4 w-4" />
                  </Button>
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex flex-col gap-2 pt-2">
                <Button asChild className="w-full">
                  <a
                    href={`https://explorer.testnet.mantle.xyz/tx/${successHash}`}
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    <ExternalLink className="h-4 w-4 mr-2" />
                    View on Explorer
                  </a>
                </Button>
                <Button
                  variant="outline"
                  className="w-full"
                  onClick={() => {
                    setSuccessModalOpen(false)
                    setSuccessHash(null)
                    navigate("/app/invoices")
                  }}
                >
                  View Invoices
                </Button>
              </div>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
    </div>
  )
}
